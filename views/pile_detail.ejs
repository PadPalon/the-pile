<%- include("header") %>

<style>
    .current-upvote {
        background-color: lightgreen;
    }

    .current-downvote {
        background-color: orange;
    }
</style>

<script type="text/javascript">
    const upvote = id => {
        sendVote(id, true)
    }

    const downvote = id => {
        sendVote(id, false)
    }

    const sendVote = (id, isUpvote) => {
        const url = `/item/vote/${isUpvote ? 'up' : 'down'}`

        const item = {
            pileId: '<%= pile.identifier %>',
            itemId: id
        }

        const options = {
            method: 'PUT',
            body: JSON.stringify(item),
            headers: {
                'Content-Type': 'application/json'
            }
        }

        fetch(url, options).then(res => window.location.reload(true))
    }

    const createItem = () => {
        const url = '/item'

        const item = {
            pileId: '<%= pile.identifier %>',
            name: document.getElementById("item-name").value
        }

        const options = {
            method: 'POST',
            body: JSON.stringify(item),
            headers: {
                'Content-Type': 'application/json'
            }
        }

        fetch(url, options).then(res => window.location.reload(true))
    }
</script>

<% const shareUrl = pageUrl + "/piles/" + pile.identifier + "/share" %>
<div class="pure-g">
    <div class="pure-u-2-3">
        <h1>Pile '<%= pile.name %>'</h1>
        <table class="pure-table pure-table-horizontal">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Votes</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            <% pile.items.sort((first, second) => (second.upvotes - second.downvotes) - (first.upvotes - first.downvotes)).forEach(item => { %>
                <tr>
                    <td><%= item.name %></td>
                    <td><%= item.upvotes - item.downvotes %></td>
                    <td>
                        <button class="<%= votes[item.identifier] === 'UP' ? 'current-upvote' : '' %> pure-button" onclick="upvote('<%= item.identifier %>')">Upvote</button>
                        <button class="<%= votes[item.identifier] === 'DOWN' ? 'current-downvote' : '' %> pure-button" onclick="downvote('<%= item.identifier %>')">Downvote</button>
                    </td>
                </tr>
            <% }) %>
            <tr>
                <td colspan="2"><input id="item-name"/></td>
                <td><button class="pure-button" onclick="createItem()">New</button></td>
            </tr>
            </tbody> 
        </table>
        <p><a href="/piles"><button class="pure-button">Go to pile list</button></a></p>
    </div>
    <div class="pure-u-1-3">
        <h2>Sharing</h2>
        <p>Link to share</p>
        <p><a href="<%= shareUrl %>"><%= shareUrl %></a></p>
        <button class="pure-button" onclick="navigator.clipboard.writeText('<%= shareUrl %>');">Copy to clipboard</button>
    </div>
</div>